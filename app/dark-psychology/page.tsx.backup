// ðŸ§  FILE PURPOSE
// Dark Psychology lessons page - displays all Dark Psychology lessons globally available to all users.
// Similar to the learn page but specifically for Dark Psychology category.

"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { useUser } from "@clerk/nextjs";
import { Button } from "@/components/ui/button";
import { Home, BookOpen, Lock, Check } from "lucide-react";
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { DARK_PSYCHOLOGY_LESSONS } from "@/lib/darkPsychologyLessons";

// Step 1: Define position calculation for lessons
// Same positioning system as learn page but for Dark Psychology lessons
const REFERENCE_WIDTH = 672;

interface LessonPosition {
  x: number;
  y: number;
}

const BASE_X_POSITIONS_IN_PIXELS = {
  1: 336, // Center
  2: 425, // Right
  3: 336, // Center
  4: 247, // Left
  5: 336, // Center
  6: 425, // Right
  7: 336, // Center
  8: 247, // Left
  9: 336, // Center
  10: 425, // Right
};

const BASE_Y_POSITIONS = {
  1: 60,
  2: 160,
  3: 260,
  4: 360,
  5: 460,
  6: 560,
  7: 660,
  8: 760,
  9: 860,
  10: 960,
};

const CYCLE_HEIGHT = 1100;

const getLessonPosition = (positionNumber: number): LessonPosition => {
  const cycle = Math.floor((positionNumber - 1) / 10);
  const positionInCycle = ((positionNumber - 1) % 10) + 1;

  const baseX = BASE_X_POSITIONS_IN_PIXELS[positionInCycle as keyof typeof BASE_X_POSITIONS_IN_PIXELS];
  const baseY = BASE_Y_POSITIONS[positionInCycle as keyof typeof BASE_Y_POSITIONS];

  const actualY = baseY + (cycle * CYCLE_HEIGHT);

  return {
    x: (baseX / REFERENCE_WIDTH) * 100,
    y: actualY
  };
};

// âœ… Positioning system setup complete - lessons will display in a path

export default function DarkPsychologyPage() {
  const router = useRouter();
  const { user } = useUser();
  const userEmail = user?.primaryEmailAddress?.emailAddress;

  // Load user progress to check completed lessons
  const progress = useQuery(api.lessons.getUserProgress, userEmail ? { email: userEmail } : "skip");

  // Step 2: Handle lesson click
  // Store lesson data and navigate to practice page
  const handleStartLesson = (lessonNumber: number) => {
    localStorage.setItem('currentLessonNumber', lessonNumber.toString());
    localStorage.setItem('lessonCategory', 'dark-psychology');
    router.push('/yourlesson');
  };

  const isLessonCompleted = (lessonNumber: number) => {
    if (!progress) return false;
    return progress.some(p => p.lessonNumber === lessonNumber && p.isCompleted);
  };

  // âœ… Lesson interaction handlers ready

  return (
    <div className="min-h-screen bg-[#1F2937]">
      {/* Header */}
      <div className="bg-[#1F2937] border-b border-gray-700 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold text-white">Dark Psychology</h1>
          </div>
          <div className="flex items-center gap-4">
            <Button
              variant="outline"
              onClick={() => router.push("/admin/add-dark-psychology-lesson")}
              className="flex items-center gap-2"
            >
              <BookOpen className="h-4 w-4" />
              Add Lesson
            </Button>
            <Button
              variant="outline"
              onClick={() => router.push("/learn")}
              className="flex items-center gap-2"
            >
              <Home className="h-4 w-4" />
              Back to Learn
            </Button>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-2xl mx-auto px-4 py-8">
        <div className="mb-8 bg-purple-900/30 border border-purple-700 rounded-lg p-6">
          <h2 className="text-xl font-bold text-white mb-2">
            ðŸ“š Understanding Dark Psychology
          </h2>
          <p className="text-gray-300">
            Learn to recognize and defend against manipulation tactics. These lessons are designed for defensive purposes only.
          </p>
        </div>

        {/* Lesson Path */}
        <div className="relative" style={{ minHeight: '1200px' }}>
          {/* Background Path Line */}
          <svg
            className="absolute top-0 left-0 w-full h-full pointer-events-none"
            style={{ zIndex: 0 }}
          >
            <path
              d={`M ${REFERENCE_WIDTH / 2} 0 L ${REFERENCE_WIDTH / 2} ${BASE_Y_POSITIONS[1]}`}
              stroke="#4B5563"
              strokeWidth="8"
              strokeDasharray="20,10"
              fill="none"
            />
            {DARK_PSYCHOLOGY_LESSONS.map((_, index) => {
              const currentPos = getLessonPosition(index + 1);
              const nextPos = getLessonPosition(index + 2);
              if (!nextPos) return null;

              return (
                <path
                  key={`path-${index}`}
                  d={`M ${currentPos.x}% ${currentPos.y} L ${nextPos.x}% ${nextPos.y}`}
                  stroke="#4B5563"
                  strokeWidth="8"
                  strokeDasharray="20,10"
                  fill="none"
                />
              );
            })}
          </svg>

          {/* Lessons */}
          {DARK_PSYCHOLOGY_LESSONS.map((lesson) => {
            const position = getLessonPosition(lesson.number);
            const completed = isLessonCompleted(lesson.number);
            const isLocked = false; // Disabled lock feature

            // Calculate progress for multi-part lessons
            const totalParts = lesson.totalParts || 1;
            const lessonProgress = progress?.find(p => p.lessonNumber === lesson.number);
            const completedParts = lessonProgress?.completedParts?.length || 0;
            const progressPercentage = completed ? 100 : (completedParts / totalParts) * 100;

            // Calculate stroke dash for progress ring
            const circumference = 2 * Math.PI * 44;
            const strokeDashoffset = circumference * (1 - progressPercentage / 100);

            return (
              <div
                key={lesson.number}
                className="absolute"
                style={{
                  left: `${position.x}%`,
                  top: `${position.y}px`,
                  transform: 'translate(-50%, -50%)',
                  zIndex: 10,
                }}
              >
                {/* Progress Ring */}
                <svg
                  className="absolute inset-0 w-24 h-24"
                  style={{
                    left: '50%',
                    top: '50%',
                    transform: 'translate(-50%, -50%) rotate(-90deg)',
                  }}
                >
                  {/* Background ring */}
                  <circle
                    cx="48"
                    cy="48"
                    r="44"
                    fill="none"
                    stroke="#374151"
                    strokeWidth="4"
                  />

                  {/* Segment dividers for multi-part lessons */}
                  {totalParts > 1 && Array.from({ length: totalParts }).map((_, index) => {
                    const angle = (360 / totalParts) * index;
                    const x1 = 48;
                    const y1 = 48;
                    const x2 = 48 + 44 * Math.cos((angle - 90) * Math.PI / 180);
                    const y2 = 48 + 44 * Math.sin((angle - 90) * Math.PI / 180);
                    return (
                      <line
                        key={index}
                        x1={x1}
                        y1={y1}
                        x2={x2}
                        y2={y2}
                        stroke="#1F2937"
                        strokeWidth="2"
                      />
                    );
                  })}

                  {/* Progress ring */}
                  <circle
                    cx="48"
                    cy="48"
                    r="44"
                    fill="none"
                    stroke={completed ? '#FBBF24' : '#A855F7'}
                    strokeWidth="4"
                    strokeDasharray={circumference}
                    strokeDashoffset={strokeDashoffset}
                    className="transition-all duration-500"
                    strokeLinecap="round"
                  />
                </svg>

                <button
                  onClick={() => handleStartLesson(lesson.number)}
                  className={`relative w-20 h-20 rounded-full flex items-center justify-center text-2xl font-bold transition-all
                    ${completed
                      ? 'bg-purple-600 hover:bg-purple-700 text-white'
                      : 'bg-purple-500 hover:bg-purple-600 text-white hover:scale-110'
                    }
                    border-4 ${completed ? 'border-yellow-400' : 'border-purple-800'}
                  `}
                >
                  {completed ? (
                    <Check className="h-10 w-10" />
                  ) : (
                    lesson.number
                  )}
                </button>

                {/* Lesson Title */}
                <div className="absolute top-24 left-1/2 transform -translate-x-1/2 w-48 text-center">
                  <p className="text-white font-bold text-sm mb-1">
                    Lesson {lesson.number}
                  </p>
                  <p className="text-gray-300 text-xs">
                    {lesson.title}
                  </p>
                </div>
              </div>
            );
          })}
        </div>

        {/* Empty State */}
        {DARK_PSYCHOLOGY_LESSONS.length === 0 && (
          <div className="text-center py-12">
            <h2 className="text-xl font-bold text-white mb-2">No Lessons Yet</h2>
            <p className="text-gray-400 mb-4">
              Dark Psychology lessons will appear here once they are added.
            </p>
            <Button
              onClick={() => router.push("/admin/add-dark-psychology-lesson")}
              className="bg-purple-600 hover:bg-purple-700"
            >
              Add First Lesson
            </Button>
          </div>
        )}
      </div>
    </div>
  );
}

// âœ… Dark Psychology page complete:
// - Displays all Dark Psychology lessons in a path format
// - Lessons are locked until previous lesson is completed
// - Clicking a lesson navigates to practice page
// - Shows completion status with checkmarks
